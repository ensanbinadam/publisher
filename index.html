<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ù†Ø§Ø´Ø±  Ù„Ø®Ø·Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ù‡Ø¬</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ø§Ø­Ù‚Ù‹Ø§:
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  -->

<style>
  :root{
    --panel-bg:#fff; --panel-bd:#e5e7eb; --panel-title:#0f172a;
    --tag:#2563eb; --muted:#6b7280; --chip:#eef2ff;
    --gap:16px;
  }

  /* ===== Ø´Ø§Ø´Ø© ===== */
  *{box-sizing:border-box}
  html,body{margin:0}
  body{font-family:'Cairo',sans-serif;background:#f5f7fa;color:#0f172a}
  .wrap{max-width:1200px;margin:auto;padding:16px}

  /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ */
  .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin-bottom:12px}
  .btn{cursor:pointer;border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:8px 12px;font-weight:700}
  .btn:hover{box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}

  /* Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‡ÙˆÙŠØ© */
  .panel{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:14px}
  .panel-hd{padding:10px 14px;border-bottom:1px dashed var(--panel-bd);font-weight:800}
  .panel-bd{padding:12px 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-weight:700}
  input[type="text"],input[type="email"]{
    padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;min-width:220px;background:#fff
  }
  .muted{color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}

  /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© + Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ø¹Ø±Ø¶) */
  .site-header{
    display:grid;grid-template-columns:220px 1fr 220px;gap:12px;
    background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;margin:12px 0
  }
  .site-header .col{display:flex;align-items:center;gap:10px}
  .site-header .center{justify-content:center}
  .site-header .left{flex-direction:column;align-items:center;justify-content:center;text-align:center}
  .logo{width:200px;height:100px;border:none;background:transparent;border-radius:12px;object-fit:contain;}
  .title{margin:0;text-align:center;font-weight:800;font-size:26px;line-height:1.2}

  /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
  @media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:800px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:520px){.grid{grid-template-columns:1fr}}

  /* Ø¨Ø·Ø§Ù‚Ø© Ø£Ø³Ø¨ÙˆØ¹ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·) */
  .card{
    background:#fff;border:0;border-radius:14px;
    box-shadow:0 8px 22px rgba(2,6,23,.06), 0 1px 3px rgba(15,23,42,.06);
    display:flex;flex-direction:column;overflow:hidden
  }
  .card-header{display:flex;justify-content:center;align-items:center;padding:10px 12px;background:#f8fbff;border-bottom:1px solid #e5e7eb}
  .badge{background:var(--chip);color:#1e3a8a;padding:6px 10px;border-radius:10px;font-weight:800}
  .card-body{padding:10px 12px;display:flex;flex-direction:column;gap:8px}

  /* Ø§Ù„ØªØ§Ø±ÙŠØ® Ø³Ø·Ø±Ø§Ù† */
  .date-lines{display:flex;flex-direction:column;align-items:center;gap:4px;margin:2px 0 6px}
  .hijri-line{font-size:14px;color:#334155;font-weight:700}
  .greg-line{font-size:14px;color:#2563eb;font-weight:800}

  /* Ø³Ø·ÙˆØ± Ø§Ù„Ø£ÙŠØ§Ù… (Ø£Ø±Ù‚Ø§Ù…) */
  .day{display:grid;grid-template-columns:40px 1fr;align-items:center;gap:8px}
  .day label{font-weight:800;color:#0f172a;text-align:center}
  .day .val{
    padding:4px 0;border-bottom:1px dashed #cbd5e1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }

  /* ØªØ°ÙŠÙŠÙ„ (Ø¹Ø±Ø¶) */
  .site-footer{text-align:center;color:#6b7280;font-weight:700;margin:16px auto 24px}
  .footer-names{display:flex;gap:16px;justify-content:center;flex-wrap:wrap}
  .footer-pill{background:#fff;border:1px solid #d1d5db;border-radius:12px;padding:8px 14px;font-weight:800;min-width:260px}

  /* ===== Ø·Ø¨Ø§Ø¹Ø© ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© (A3/A4) ===== */
  @media print{
    html{font-size:8.5px}
    body{background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}

    /* Ø£Ø®ÙÙ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… */
    .panel,.topbar{display:none!important}

    /* Ù…ØªØºÙŠØ±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
    :root{
      --hdr:22mm;       /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© */
      --ftr:16mm;       /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
      --gapP:2.6mm;     /* ÙØ¬ÙˆØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ© */
      --mTop:10mm;      /* Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø«Ø¨Ù‘Øª */
      --mBottom:8mm;    /* Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø«Ø¨Ù‘Øª */
    }

    /* ØªÙØ³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„Ù€ JS Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ A3/A4 */
    @page{ size:A4 landscape; margin:6mm }

    /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ© */
    .site-header{
      position:fixed;left:5mm;right:5mm;top:var(--mTop);height:var(--hdr);
      margin:0;padding:4mm;border-radius:8px;background:#fff
    }
    .site-header .logo{width:256px;height:128px}
    .site-header .title{font-size:13px}

    /* Ø§Ù„Ø´Ø¨ÙƒØ© 5Ã—4 Ø¨ÙŠÙ† Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„Ø°ÙŠÙ„ */
    #weeks{
      position:fixed;left:5mm;right:5mm;
      top:calc(var(--mTop) + var(--hdr) + 1mm);
      bottom:calc(var(--mBottom) + var(--ftr));
      display:grid;gap:var(--gapP);
      grid-template-columns:repeat(5,1fr);
      grid-template-rows:repeat(4,minmax(0,1fr));
      align-items:stretch;align-content:stretch;
    }

    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: Ù„Ø§ Ù‚ØµÙ‘ */
    .card{
      box-shadow:none;border-radius:8px;height:100%!important;
      overflow:visible !important;
      break-inside:avoid; page-break-inside:avoid;
    }
    .card-header{padding:1mm;background:#f8fbff;border:0}
    .badge{padding:.8mm 1.6mm;font-size:9px}

    .card-body{
      padding:1mm;gap:1mm;
      display:flex;flex-direction:column;min-height:0; /* Ù…Ù‡Ù… Ù„ÙÙ„ÙŠÙƒØ³ */
    }
    .date-lines{margin:.8mm 0 1.2mm}
    .hijri-line,.greg-line{font-size:8px}
    .day{grid-template-columns:30px 1fr;gap:1mm}
    .day .val{font-size:6.6px;min-height:7px;line-height:1.1}

    /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ø«Ø¨Ù‘Øª */
    .site-footer{
      position:fixed;left:5mm;right:5mm;bottom:var(--mBottom);height:var(--ftr);
      margin:0;padding-top:2mm;background:#fff
    }

    /* ÙˆØ¶Ø¹ A4 Ø§Ù„Ù…Ø¶ØºÙˆØ· Ù„Ù…Ù†Ø¹ Ø£ÙŠ Ù‚ØµÙ‘ */
    body.a4fit{
      --hdr:18.5mm;         /* Ø±Ø£Ø³ Ø£ØµØºØ± */
      --ftr:12mm;           /* Ø°ÙŠÙ„ Ø£ØµØºØ± */
      --gapP:1.6mm;         /* ÙØ¬ÙˆØ§Øª Ø£ØµØºØ± */
    }
    body.a4fit #weeks{
      top:calc(var(--mTop) + var(--hdr) + .5mm);
      bottom:calc(var(--mBottom) + var(--ftr) - 1mm);
      gap:var(--gapP);
    }
    body.a4fit .site-header{ padding:2.6mm }
    body.a4fit .site-header .logo{ width:160px;height:60px }
    body.a4fit .site-header .title{ font-size:11.5px }

    body.a4fit .card-header{ padding:.6mm }
    body.a4fit .badge{ font-size:7.6px; padding:.5mm 1mm }

    body.a4fit .card-body{ padding:.55mm; gap:.45mm; min-height:0 }
    body.a4fit .date-lines{ margin:.4mm 0 .8mm }
    body.a4fit .hijri-line, body.a4fit .greg-line{ font-size:6.8px }

    body.a4fit .day{ grid-template-columns:24px 1fr; gap:.45mm }
    body.a4fit .day .val{
      font-size:5.6px; min-height:5.2px; line-height:1.05;
      border-bottom:1px dashed #9ca3af;
    }
  }
</style>

  <style id="uiHide">
  /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
   #btnEmail, #applyMeta, #loadPlan, #dataUrl, label[for="dataUrl"], #emailInput, label[for="emailInput"] { display:none !important }
  .panel-bd .row { row-gap:8px } 
    /* Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­ */
  .panel-bd .hint{ display:none !important; }
</style>

  <style id="printPageSize"></style>
</head>
<body>
  <div class="wrap">

    <!-- Ø£Ø²Ø±Ø§Ø± -->
    <div class="topbar">
      <button id="btnA3" class="btn">ğŸ“„ PDF â€” A3 ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©</button>
      <button id="btnA4" class="btn">ğŸ“„ PDF â€” A4 ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©</button>
      <button id="btnEmail" class="btn">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‡ÙˆÙŠØ© -->
    <section class="panel">
      <div class="panel-hd">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© â€” Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©/Ø§Ù„ØªØ°ÙŠÙŠÙ„</div>
      <div class="panel-bd">
        <div class="row" style="margin-bottom:8px">
          <label for="eduInput">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…:</label><input id="eduInput" type="text" placeholder="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…">
          <label for="schoolInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</label><input id="schoolInput" type="text" placeholder="Ù…Ø¯Ø±Ø³Ø© ...">
        </div>
        <div class="row" style="margin-bottom:8px">
          <label for="mgrInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±/Ø©:</label><input id="mgrInput" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±/Ø©">
          <label for="tchInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©:</label><input id="tchInput" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©">
        </div>
        <div class="row" style="margin-bottom:8px">
          <label for="emailInput">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label><input id="emailInput" type="email" placeholder="name@example.com">
          <button id="applyMeta" class="btn primary" type="button">ØªØ·Ø¨ÙŠÙ‚</button>
          <span class="hint">ÙŠÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</span>
        </div>
        <div class="row">
          <label for="dataUrl">Ù…ØµØ¯Ø± Ø§Ù„Ø®Ø·Ø© (JSON):</label>
          <input id="dataUrl" type="text" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ?data= Ø£Ùˆ plan.json">
          <button id="loadPlan" class="btn" type="button">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©</button>
          <span class="hint">ÙŠÙ…ÙƒÙ† ÙˆØ¶Ø¹ ?data=Ø±Ø§Ø¨Ø·.json ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.</span>
        </div>
      </div>
    </section>

    <!-- Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© -->
    <header class="site-header" id="printHeader">
      <div class="col right"><img id="logoImg" class="logo" alt="Ø´Ø¹Ø§Ø±" src=""></div>
      <div class="col center"><h1 class="title" id="headerTitle">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ù‡Ø¬</h1></div>
      <div class="col left">
        <div id="eduLine" style="font-weight:800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
        <div id="schoolLine" class="muted">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
      </div>
    </header>

    <!-- Ø§Ù„Ø´Ø¨ÙƒØ© -->
    <section id="weeks" class="grid"></section>
<!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
<footer class="site-footer" id="printFooter" role="contentinfo">
  <div class="footer-names">
    <div class="footer-pill" id="footerTeacher">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©: â€”</div>
    <div class="footer-pill" id="footerManager">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±/Ø©: â€”</div>
  </div>

  <div class="footer-meta">
    <span>ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ø£/ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ ğŸ¦‹</span>
    <span class="sep">â€”</span>
    <a href="https://t.me/fatmahhzaze" dir="ltr" target="_blank" rel="noopener">t.me/fatmahhzaze</a>
  </div>

  <div class="copyright">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
</footer>

  <!-- Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
  <template id="week-tpl">
    <article class="card" data-week>
      <div class="card-header">
        <span class="badge" data-week-title></span>
      </div>
      <div class="card-body">
        <div class="date-lines">
          <div class="hijri-line" data-hijri-line></div>
          <div class="greg-line"  data-greg-line></div>
        </div>
        <!-- Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¯Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… -->
        <div class="day"><label>1</label><div class="val" data-day="0"></div></div>
        <div class="day"><label>2</label><div class="val" data-day="1"></div></div>
        <div class="day"><label>3</label><div class="val" data-day="2"></div></div>
        <div class="day"><label>4</label><div class="val" data-day="3"></div></div>
        <div class="day"><label>5</label><div class="val" data-day="4"></div></div>
      </div>
    </article>
  </template>

  <script>
  (function(){
    // Ø¹Ù†Ø§ØµØ±
    const DAY_NUMS_AR = ['Ù¡','Ù¢','Ù£','Ù¤','Ù¥'];
    const DAY_NAMES_AR = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³']; // Ù„Ù„ØªÙ„Ù…ÙŠØ­

    const weeksEl   = document.getElementById('weeks');
    const btnA3     = document.getElementById('btnA3');
    const btnA4     = document.getElementById('btnA4');
    const btnEmail  = document.getElementById('btnEmail');
    const dataUrl   = document.getElementById('dataUrl');
    const loadPlan  = document.getElementById('loadPlan');

    const headerTitle = document.getElementById('headerTitle');
    const logoImg     = document.getElementById('logoImg');
    const eduLine     = document.getElementById('eduLine');
    const schoolLine  = document.getElementById('schoolLine');
    const footerTeacher = document.getElementById('footerTeacher');
    const footerManager = document.getElementById('footerManager');

    const eduInput   = document.getElementById('eduInput');
    const schoolInput= document.getElementById('schoolInput');
    const mgrInput   = document.getElementById('mgrInput');
    const tchInput   = document.getElementById('tchInput');
    const emailInput = document.getElementById('emailInput');
    const applyMeta  = document.getElementById('applyMeta');

    const printPageSize = document.getElementById('printPageSize');

    // ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ©
    const LS_META = 'pub.meta.v1';

    // Ø£Ø¯ÙˆØ§Øª ØªØ§Ø±ÙŠØ®
    const pad2 = n => String(n).padStart(2,'0');
    const fmtGreg = d => `${d.getFullYear()} / ${pad2(d.getMonth()+1)} / ${pad2(d.getDate())}`;
const fmtHijriDMY = (d) => {
  try {
    const f = new Intl.DateTimeFormat(
      'ar-SA-u-ca-islamic-umalqura-nu-arab',
      { day:'2-digit', month:'2-digit', year:'numeric' }
    );
    const parts = f.formatToParts(d);
    const pick = t => (parts.find(p => p.type===t)?.value || '').replace(/\u200f/g,'');
    return `${pick('day')} / ${pick('month')} / ${pick('year')} Ù‡Ù€`;
  } catch { return 'Ù‡Ø¬Ø±ÙŠ'; }
};

    // ÙŠØ·Ø¨Ù‘Ù‚ Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆÙŠØ®Ø²Ù†Ù‡Ø§
    function applyIdentity(){
      eduLine.textContent   = eduInput.value.trim()   || 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…';
      schoolLine.textContent= schoolInput.value.trim()|| 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
      footerManager.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±/Ø©: ' + (mgrInput.value.trim() || 'â€”');
      footerTeacher.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©: ' + (tchInput.value.trim() || 'â€”');
      const meta = {
        edu: eduInput.value||'',
        school: schoolInput.value||'',
        mgr: mgrInput.value||'',
        tch: tchInput.value||'',
        email: emailInput.value||''
      };
      localStorage.setItem(LS_META, JSON.stringify(meta));
    }
    // Ø²Ø± "ØªØ·Ø¨ÙŠÙ‚" ÙŠØ¨Ù‚Ù‰ ÙŠØ¹Ù…Ù„
    applyMeta.addEventListener('click', applyIdentity);

    // --- ØªØ·Ø¨ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨ØªÙ‡Ø¯Ø¦Ø© (debounce) ---
    function debounce(fn, delay=300){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    }
    const applyIdentityDebounced = debounce(applyIdentity, 300);
    [eduInput, schoolInput, mgrInput, tchInput, emailInput].forEach(el=>{
      if(!el) return;
      el.addEventListener('input', applyIdentityDebounced);
      el.addEventListener('change', applyIdentityDebounced);
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡ÙˆÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    (function loadIdentity(){
      try{
        const raw = localStorage.getItem(LS_META);
        if(!raw) return;
        const m = JSON.parse(raw);
        eduInput.value = m.edu||'';
        schoolInput.value = m.school||'';
        mgrInput.value = m.mgr||'';
        tchInput.value = m.tch||'';
        emailInput.value = m.email||'';
        applyIdentity();
      }catch(_){}
    })();

    // Ø§Ø®ØªÙŠØ§Ø± Ø±Ø§Ø¨Ø· JSON Ù…Ù† ?data= Ø£Ùˆ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø£Ùˆ plan.json
    function pickDataURL(){
      const u = dataUrl.value.trim();
      if(u) return u;
      const params = new URLSearchParams(location.search);
      const fromQ = params.get('data');
      if(fromQ) return fromQ;
      return 'plan.json';
    }

    // ØªØµØ­ÙŠØ­ Ù…Ø³Ø§Ø±/ØªØ±Ù…ÙŠØ² Ø§Ù„Ø´Ø¹Ø§Ø±
    function setLogoSrc(raw){
      const s = (raw || '').trim();
      if(!s) return;
      logoImg.src = s.startsWith('data:image/')
        ? s.replace(/\s+/g,'').replace(/ /g,'+')
        : s;
    }

    // Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
    function renderWeeks(weeks, title, logo, hdrMeta){
      weeksEl.innerHTML = '';
      if (title) headerTitle.textContent = title;
      if (logo)  setLogoSrc(logo);

      // Ù„Ùˆ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡ÙˆÙŠØ© Ø¯Ø§Ø®Ù„ header ÙÙŠ JSONØŒ Ø§Ø¹Ø±Ø¶Ù‡Ø§
      if(hdrMeta){
        if(hdrMeta.edu)    eduLine.textContent    = hdrMeta.edu;
        if(hdrMeta.school) schoolLine.textContent = hdrMeta.school;
        if(hdrMeta.mgr)    footerManager.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±/Ø©: ' + hdrMeta.mgr;
        if(hdrMeta.tch)    footerTeacher.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©: ' + hdrMeta.tch;
      }

      weeks.forEach((w,idx)=>{
        const tpl = document.getElementById('week-tpl').content.cloneNode(true);
        const node= tpl.firstElementChild;
        node.querySelector('[data-week-title]').textContent = `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${idx+1}`;

        const df = new Date(w.from);
        const dt = new Date(w.to);
        node.querySelector('[data-hijri-line]').textContent = `${fmtHijriDMY(df)} â€” ${fmtHijriDMY(dt)}`;
        node.querySelector('[data-greg-line]').textContent  = `${fmtGreg(df)} â€” ${fmtGreg(dt)}`;

        const days = Array.isArray(w.days) ? w.days : [];
        node.querySelectorAll('.val').forEach(val=>{
          const i = Number(val.dataset.day);
          val.textContent = (days[i] || '').trim();
        });

        // Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©-Ù‡Ù†Ø¯ÙŠØ© + ØªÙ„Ù…ÙŠØ­
        node.querySelectorAll('.day label').forEach((lab, i) => {
          lab.textContent = DAY_NUMS_AR[i] || lab.textContent;
          lab.title = DAY_NAMES_AR[i] || '';
        });

        weeksEl.appendChild(node);
      });

      // Ø£Ø¹ÙØ¯ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù… (Ø£ÙˆÙ„ÙˆÙŠØ© Ø£Ø¹Ù„Ù‰ Ù…Ù† JSON)
      applyIdentity();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·Ø© Ù…Ù† JSON (ÙŠØ¯Ø¹Ù… top-level Ø£Ùˆ Ø¯Ø§Ø®Ù„ header)
    async function loadPlanFromJSON(){
      const url = pickDataURL();
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw 0;
        const j = await res.json();

        const title = j.title || (j.header && j.header.title) || null;
        const logo  = j.logo  || (j.header && j.header.logo)  || null;
        const hdrMeta = j.header || null;
        const weeks = Array.isArray(j.weeks) ? j.weeks : [];

        renderWeeks(weeks, title, logo, hdrMeta);
      }catch(e){
        alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø®Ø·Ø© JSON.\nØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (CORS).');
      }
    }

    loadPlan.addEventListener('click', loadPlanFromJSON);
    loadPlanFromJSON();

    // Ø·Ø¨Ø§Ø¹Ø© ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ù…Ù‚Ø§Ø³ Ù…Ø­Ø¯Ø¯
    function printOnePage(size, tight=false){
      applyIdentity(); // ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      printPageSize.textContent =
        `@media print{ @page{ size:${size} landscape; margin:6mm } }`;
      document.body.classList.toggle('a4fit', !!tight);
      setTimeout(()=>{ try{ window.print(); }catch(_){} }, 30);
    }

    btnA3.addEventListener('click', ()=> printOnePage('A3', false)); // Ø¨Ø¯ÙˆÙ† Ø¶ØºØ·
    btnA4.addEventListener('click', ()=> printOnePage('A4', true));  // Ù…Ø¹ Ø¶ØºØ·

    window.addEventListener('afterprint', ()=> {
      document.body.classList.remove('a4fit');
    });

    // â€”â€”â€” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€”â€”â€”
    const EMAILJS_PUBLIC_KEY = '';
    const EMAILJS_SERVICE_ID = '';
    const EMAILJS_TEMPLATE_ID = '';

    async function sendEmail(){
      const to = emailInput.value.trim();
      if(!to){ alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ù‹Ø§.'); return; }
      if(!window.emailjs || !EMAILJS_PUBLIC_KEY || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID){
        alert('Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„. ÙØ¹Ù‘Ù„ EmailJS (Ø§Ù†Ø¸Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ØªÙ†Ø²ÙŠÙ„ PDF.');
        return;
      }
      try{
        window.emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
        const area = document.querySelector('.wrap');
        const canvas = await html2canvas(area, { scale: 2, useCORS:true });
        const dataUrl = canvas.toDataURL('image/png');
        const params = {
          to_email: to,
          edu: eduInput.value || '',
          school: schoolInput.value || '',
          mgr: mgrInput.value || '',
          tch: tchInput.value || '',
          img_data: dataUrl
        };
        await window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
        alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.');
      }catch(err){
        alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± EmailJS. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
      }
    }
    document.getElementById('btnEmail').addEventListener('click', sendEmail);
  })();
  </script>
</body>
</html>
